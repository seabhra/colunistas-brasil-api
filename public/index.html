<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3940256099942544"
crossorigin="anonymous"></script>

<!-- Favicon -->
<link rel="icon" href="./favicon.ico" type="image/x-icon">

<!-- √çcones PWA -->
<link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">

<!-- Manifest json -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#6b46c1">
<title>Agenda dos 300 - Duelo de Colunistas</title>

<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  padding: 10px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #fdfcfd;
  color: white;
  text-align: center;
  overflow-x: hidden;
  display: flex;
  justify-content: center;
  min-height: 100vh;
  user-select: none;
}

#pageLoader {
  position: fixed; inset: 0; background: #fdfcfd;
  z-index: 9999; display: flex; align-items: center; justify-content: center;
}

.loader-circle {
  width: 60px; height: 60px; border: 6px solid #e0e0e0;
  border-top: 6px solid #d847cf; border-radius: 50%; animation: spin 1.5s linear infinite;
}

@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.app-container {
  width: 100%;
  max-width: 360px;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: auto;
}

.menu-caixa {
  background: rgba(27, 138, 160, 0.9);
  backdrop-filter: blur(6px);
  color: #333;
  padding: 15px 10px;
  border-radius: 20px;
  width: 100%;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
}

#erroTema {
  color: #ffeb3b;
  font-size: 12px;
  font-weight: bold;
  display: none;
  margin-bottom: 10px;
}

.img-logo {
  display: block;
  margin: -10px auto 5px;
  width: 60%;
  max-width: 200px;
  aspect-ratio: 1 / 1;
  object-fit: contain;
}

.img-versus-central {
  width: 40px;
  height: 40px;
  align-self: center;
  object-fit: contain;
  margin: -10px 5px;
}

.seletor-tema {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  margin-bottom: 10px;
  border-radius: 12px;
  border: 2px solid #9d5fe9;
  background: white;
  font-weight: bold;
  color: #4a148c;
}

.btn-aurora {
  width: 100%;
  padding: 12px;
  margin-top: -5px;
  margin-bottom: -5px;
  border: none;
  border-radius: 16px;
  font-weight: bold;
  cursor: pointer;
  color: white;
  font-size: 16px;
  transition: transform 0.2s ease;
}

.btn-aurora:active { transform: scale(0.97); }

.roxo   { background: #FA8072; color: #1a1a1a; }
.rosa   { background: #16efbd; color: #1a1a1a; }
.azul-info { background: #4caedf; cursor: default; color: white; }
.verde  { background: #74e95a; color: #1a1a1a; }

.amarelo-alerta {
  background: #ffc107;
  color: #333;
  cursor: default;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%   { opacity: 1; box-shadow: 0 0 0 0   rgba(255,193,7,0.7); }
  70%  { opacity: 0.8; box-shadow: 0 0 0 10px rgba(255,193,7,0); }
  100% { opacity: 1; box-shadow: 0 0 0 0   rgba(255,193,7,0); }
}

/* Bot√£o de √Åudio */
.btn-appinventor {
  background: #9c27b0;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid #CC93ED;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 18px;
  color: white;
  flex-shrink: 0;
  outline: none;
  /* pointer-events:none: o clique √© capturado pelo div-pai exclusivo */
  pointer-events: none;
}

/* Bot√£o Zap */
.btn-zap-redondo {
  width: 40px;
  height: 40px;
  cursor: pointer;
  display: block;
  flex-shrink: 0;
  object-fit: contain;
  border-radius: 50%;
  background-color: #25D366;
  padding: 2px;
  outline: none;
  /* pointer-events:none: o clique √© capturado pelo div-pai exclusivo */
  pointer-events: none;
}

/* Wrapper de bot√£o: √°rea de toque exclusiva, sem sobreposi√ß√£o */
.btn-wrapper {
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  /* Garante que cada wrapper n√£o invada o vizinho */
  overflow: hidden;
}

#jogoArea {
  display: none;
  width: 100%;
  flex-direction: column;
  align-items: center;
}

.cards-area {
  display: none;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin-top: 5px;
  margin-bottom: 5px;
  margin-left: auto;
  margin-right: auto;
  padding: 10px;
  background: rgba(255,255,255,0.6);
  border-radius: 20px;
  width: 100%;
}

.card-container {
  width: 48%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.card {
  width: 100%;
  height: 200px;
  background: #1a1a1a;
  border-radius: 15px;
  border: 3px solid #fff;
  overflow: hidden;
  box-shadow: 0 8px 16px rgba(0,0,0,0.3);
  position: relative;
  margin-bottom: 8px;
  transition: transform 0.3s;
}

.card img { width: 100%; height: 100%; object-fit: cover; object-position: top; }

.label-card {
  position: absolute;
  top: 0;
  width: 100%;
  background: rgba(107, 70, 193, 0.9);
  color: #fff;
  font-size: 11px;
  padding: 4px 0;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1px;
  text-align: center;
  z-index: 2;
  border-bottom: 1px solid rgba(255,255,255,0.3);
}

.nome-colunista {
  background: white;
  color: #333;
  font-size: 12px;
  padding: 6px 2px;
  border-radius: 8px;
  width: 100%;
  min-height: 45px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  font-weight: 700;
  line-height: 1.1;
  border: 1px solid #ddd;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.text-veiculo {
  font-size: 10px;
  color: #666;
  font-weight: 400;
  margin-top: 2px;
}

#status {
  margin-top: 5px;
  margin-bottom: 5px;
  font-size: 13px;
  color: #555;
  background: rgba(255,255,255,0.8);
  padding: 10px;
  width: 100%;
  border-radius: 10px;
  display: block;
  text-align: center;
}

#aiBox {
  display: none;
  background: white;
  color: #333;
  padding: 15px;
  border-radius: 15px;
  text-align: left;
  margin: 10px 0;
  width: 100%;
  font-size: 14px;
  line-height: 1.5;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  position: relative;
  overflow: visible;
  border: 1px solid #eee;
}

#ad-container {
  margin-top: 20px;
  min-height: 100px;
  background-color: #f9f9f9;
  border-radius: 8px;
  padding: 5px;
  border: 1px solid #ddd;
}
</style>
</head>

<body onload="document.getElementById('pageLoader').style.display='none';">
<div id="pageLoader"><div class="loader-circle"></div></div>

<div class="app-container">

  <!-- MENU INICIAL -->
  <div id="menuInicial" class="menu-caixa">
    <div class="banner-abertura">
        <img src="imagens_app/logo_agenda.png" class="img-logo" alt="Agenda">
    </div>
    <p style="color:#ede4e4; font-weight: bold; margin: 5px 0;">Digite ou selecione um tema:</p>
    <div id="erroTema">‚ö†Ô∏è Por favor, escolha um tema antes de iniciar!</div>
    <input list="temasColunistas" id="seletorTema" class="seletor-tema" placeholder="Escreva seu pr√≥prio tema...">
    <datalist id="temasColunistas"></datalist>
    <button onclick="iniciarDuelo()" class="btn-aurora roxo">‚öîÔ∏è Bora (re)Pautar a M√≠dia</button>
  </div>

  <!-- √ÅREA DE JOGO -->
  <div id="jogoArea">
    <div class="cards-area" id="containerFilosofos">
      <div class="card-container">
        <div class="card">
          <div class="label-card">Colunistas</div>
          <img id="fotoLunar" src="imagens_app/colunista1.png" alt="Colunista 1">
        </div>
        <div id="nomeLunar" class="nome-colunista">Aguardando...</div>
      </div>

      <img src="imagens_app/versusX.png" class="img-versus-central">

      <div class="card-container">
        <div class="card">
          <div class="label-card">Colunistas</div>
          <img id="fotoSolar" src="imagens_app/colunista2.png" alt="Colunista 2">
        </div>
        <div id="nomeSolar" class="nome-colunista">Aguardando...</div>
      </div>
    </div>

    <div id="areaBotaoAcao">
      <button id="btnSorteio" class="btn-aurora rosa" onclick="sortear()">‚ôüÔ∏èJogar Agenda Setting Real</button>
    </div>

    <div id="status">Est√° preparado? Nesta reda√ß√£o virtual, 300 maiores nomes do colunismo e da opini√£o p√∫blica se enfrentam sem filtro institucional. Em total anonimato, seus avatares ‚Äî entre colunistas, influencers e ativistas ‚Äî desmontam o vi√©s passional das m√≠dias tradicionais e das redes em busca da metaverdade numa agenda setting real. Fora dos altos muros das newsroons, o texto vira arma e a raz√£o, escudo da sociedade. Escolha um tema ‚Äî mas aten√ß√£o: desse choque de narrativas sempre sobram farpas.</div>

    <div id="aiBox">
      <div id="ad-container">
        <span style="font-size:10px;color:#999;text-align:center;display:block">Publicidade</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3940256099942544"
             data-ad-slot="6300978111"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    </div>

  </div>
</div>

<script>
// =======================================================================
// ARQUITETURA DE √ÅUDIO
//
// O App Inventor 2 bloqueia audio.play() chamado pelo HTML ‚Äî n√£o h√°
// como contornar isso via JavaScript. A solu√ß√£o correta √©:
//
//   HTML  ‚Üí  App Inventor: envia "MUSICA_PLAY" / "MUSICA_PAUSE" / "SHARE:texto"
//   App Inventor: usa bloco [WebViewer.WebViewStringChange] para receber
//                 e aciona o componente Player nativo com o arquivo de √°udio.
//
// O HTML controla apenas o √≠cone do bot√£o (üîä / üîá) e o estado l√≥gico.
// O shuffleAudio (slots_machine.mp3) ainda √© tocado pelo HTML pois √©
// um efeito curto disparado por intera√ß√£o direta do usu√°rio (bot√£o),
// o que os navegadores WebView permitem.
// =======================================================================

// ---- Estado do √°udio de fundo (gerenciado logicamente pelo HTML) ----
let musicaTocando = false;

// Envia comando ao App Inventor via setWebViewString.
// No App Inventor: use o bloco [WebViewer1.WebViewStringChange] para ler.
function enviarComandoApp(cmd) {
  if (window.AppInventor && window.AppInventor.setWebViewString) {
    window.AppInventor.setWebViewString(cmd);
  }
}

// Atualiza o √≠cone do bot√£o de √°udio conforme o estado l√≥gico
function atualizarIconeAudio() {
  var btn = document.getElementById('btnAppInventor');
  if (btn) btn.textContent = musicaTocando ? "üîä" : "üîá";
}

// Chamado pelo App Inventor (bloco CallWebViewer.RunJavaScript ou similar)
// para informar o HTML que o Player nativo iniciou ou parou.
// Exemplo de uso no App Inventor:
//   WebViewer1.RunJavaScript("receberStatusApp('TOCANDO')")
function receberStatusApp(status) {
  if (status === 'TOCANDO') {
    musicaTocando = true;
  } else if (status === 'PARADO') {
    musicaTocando = false;
  }
  atualizarIconeAudio();
}

// ---- √Åudio de efeito (slots) ‚Äî permitido pois √© por intera√ß√£o direta ----
const shuffleAudio = new Audio('audio_app/slots_machine.mp3');
shuffleAudio.preload = 'auto';
shuffleAudio.volume = 0.5;

// ---------------- TEMAS ----------------
fetch("https://raw.githubusercontent.com/seabhra/colunistas-brasil-api/refs/heads/main/public/temas_colunitas.json")
  .then(res => res.json())
  .then(data => {
    const datalist = document.getElementById("temasColunistas");
    datalist.innerHTML = "";
    const lista = Array.isArray(data) ? data : (data.temas || []);
    lista.forEach(tema => {
      const option = document.createElement("option");
      option.value = tema;
      datalist.appendChild(option);
    });
    console.log("Carregados " + lista.length + " temas.");
  }).catch(err => console.log("Erro ao carregar temas:", err));

// ---------------- DADOS ----------------
let listaTodosColunistas = [];
let colunista1 = {};
let colunista2 = {};

async function carregarColunistas() {
  try {
    const resposta = await fetch('colunistas-brasil.json');
    if (!resposta.ok) throw new Error("colunistas-brasil.json n√£o encontrado");
    const dados = await resposta.json();
    listaTodosColunistas = dados.colunistas || [];
    console.log("Carregados " + listaTodosColunistas.length + " colunistas.");
  } catch (erro) {
    console.error("Erro ao carregar colunistas:", erro);
  }
}

carregarColunistas();

// ---------------- JOGO ----------------
function iniciarDuelo() {
  const temaInput = document.getElementById('seletorTema').value;
  const erroEl = document.getElementById('erroTema');
  if (temaInput.trim() === "") {
    erroEl.style.display = 'block';
    return;
  }
  erroEl.style.display = 'none';
  document.getElementById('menuInicial').style.display = 'none';
  document.getElementById('jogoArea').style.display = 'flex';
  document.getElementById('containerFilosofos').style.display = 'flex';
}

function sortear() {
  if (listaTodosColunistas.length < 2) {
    alert("Lista de colunistas insuficiente para um duelo.");
    return;
  }

  // Para m√∫sica de fundo (via App Inventor)
  musicaTocando = false;
  atualizarIconeAudio();
  enviarComandoApp("MUSICA_PAUSE");

  // Efeito sonoro ‚Äî disparado por intera√ß√£o direta, permitido pelo WebView
  shuffleAudio.currentTime = 0;
  shuffleAudio.play().catch(e => console.log("shuffle bloqueado:", e));

  document.getElementById('status').innerText = "No combate ao conluio de narrativas institucionalizadas, colunistas, influencers e ativistas mais incisivos da atualidade preparam seus argumentos. A luta √© contra a desinforma√ß√£o e o discurso raso direcionado. Na arena da imprensa sem vi√©s de censura, Agenda dos 300 analisa os dados para impedir que a paix√£o cegue a raz√£o informada.";

  const areaBotao = document.getElementById('areaBotaoAcao');
  areaBotao.innerHTML = `<button class="btn-aurora azul-info">‚öîÔ∏è Colunistas em combate...</button>`;

  const aiBox = document.getElementById('aiBox');
  if (aiBox.style.display === 'block') aiBox.style.display = 'none';

  let temp1, temp2;
  let ciclos = 0;

  const intervalo = setInterval(() => {
    let idx1 = Math.floor(Math.random() * listaTodosColunistas.length);
    let idx2 = Math.floor(Math.random() * listaTodosColunistas.length);
    while (idx1 === idx2) idx2 = Math.floor(Math.random() * listaTodosColunistas.length);

    temp1 = listaTodosColunistas[idx1];
    temp2 = listaTodosColunistas[idx2];

    document.getElementById('fotoLunar').src = temp1.imagem || "imagens_app/colunista1.png";
    document.getElementById('fotoSolar').src = temp2.imagem || "imagens_app/colunista2.png";

    const v1 = temp1.Ve√≠culo ? `<span class="text-veiculo">${temp1.Ve√≠culo}</span>` : '';
    const v2 = temp2.Ve√≠culo ? `<span class="text-veiculo">${temp2.Ve√≠culo}</span>` : '';

    document.getElementById('nomeLunar').innerHTML = `${temp1.codinome}${v1}`;
    document.getElementById('nomeSolar').innerHTML = `${temp2.codinome}${v2}`;

    if (ciclos++ > 100) {
      clearInterval(intervalo);
      shuffleAudio.pause();
      colunista1 = temp1;
      colunista2 = temp2;
      areaBotao.innerHTML = `<button class="btn-aurora amarelo-alerta">‚è≥ Aguarde um instante...</button>`;
      gerarConfrontoIA();
    }
  }, 80);
}

// ---------------- API CHAT ----------------
async function gerarConfrontoIA() {
  const statusEl = document.getElementById('status');
  const tema = document.getElementById('seletorTema').value || "Atualidade";

  statusEl.innerText = `Os colunistas ${colunista1.codinome} vs ${colunista2.codinome} travam um duelo moderado por IA em nome da metaverdade sem vi√©s institucional.`;

  const promptTexto = `Atue como um mediador de debate p√∫blico. Promova um duelo de ideias racional e profundo entre ${colunista1.codinome} (${colunista1.vi√©s_politico}, ve√≠culo: ${colunista1.Ve√≠culo}) e ${colunista2.codinome} (${colunista2.vi√©s_politico}, ve√≠culo: ${colunista2.Ve√≠culo}) sobre o tema: ${tema}. Empregue um tom jornal√≠stico e anal√≠tico a partir de textos publicados por cada um deles na m√≠dia, usando apenas seus codinomes, nunca nomes pr√≥prios.`;

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messages: [{ role: 'user', content: promptTexto }],
        model: 'llama-3.3-70b-versatile'
      })
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`Erro do servidor (${res.status}): ${errorText}`);
    }

    const data = await res.json();
    const respostaTexto = data.choices[0].message.content;
    const aiBox = document.getElementById('aiBox');

    const vd1 = colunista1.Ve√≠culo ? ` - ${colunista1.Ve√≠culo}` : '';
    const vd2 = colunista2.Ve√≠culo ? ` - ${colunista2.Ve√≠culo}` : '';

    // ----------------------------------------------------------------
    // BOT√ïES: cada um em seu pr√≥prio div-wrapper com onclick isolado.
    // pointer-events:none nos elementos internos garante que o clique
    // s√≥ seja capturado pelo wrapper ‚Äî sem depender de stopPropagation.
    // ----------------------------------------------------------------
    aiBox.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="color:#4a148c; margin:0; font-size:16px; flex-grow:1; padding-right:10px;">
          Agenda dos 300 Colunistas
        </h2>
        <div style="display:flex; align-items:center; gap:8px; flex-shrink:0;">

          <!-- WRAPPER ZAP: √°rea de toque exclusiva -->
          <div class="btn-wrapper" onclick="acionarZap()">
            <img src="imagens_app/zap.png"
                 id="btnZap"
                 class="btn-zap-redondo"
                 alt="WhatsApp">
          </div>

          <!-- WRAPPER √ÅUDIO: √°rea de toque exclusiva -->
          <div class="btn-wrapper" onclick="acionarAudio()">
            <button id="btnAppInventor" class="btn-appinventor">üîá</button>
          </div>

        </div>
      </div>

      <div id="conteudoIA" style="margin-bottom:15px;">
        <h3 style="color:#4a148c; text-align:center; margin:10px 0; font-size:15px;">
          ‚öîÔ∏è ${colunista1.codinome} (${colunista1.vi√©s_politico}${vd1}) vs ${colunista2.codinome} (${colunista2.vi√©s_politico}${vd2})
        </h3>
        <p style="font-size:12px; color:#666; text-align:center; margin-bottom:10px">
          <strong>Em pauta:</strong> ${tema}
        </p>
        <hr style="border:0; border-top:1px solid #eee;">
        <p style="font-size:14px; text-align:justify; color:#333;">${respostaTexto.replace(/\n/g, '<br>')}</p>
      </div>

      <div id="ad-container">
        <span style="font-size:10px;color:#999;text-align:center;display:block">Publicidade</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3940256099942544"
             data-ad-slot="6300978111"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    `;

    aiBox.style.display = 'block';
    aiBox.style.marginTop = "5px";
    aiBox.style.marginBottom = "5px";

    // An√°lise conclu√≠da: pede ao App Inventor para iniciar a m√∫sica nativa
    musicaTocando = true;
    atualizarIconeAudio();
    enviarComandoApp("MUSICA_PLAY");

    statusEl.innerText = "Fim de combate sob modera√ß√£o de IA.";
    statusEl.style.color = "#00cc66";
    statusEl.style.fontWeight = "bold";
    statusEl.style.fontSize = "14px";

    try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) {}

    document.getElementById('areaBotaoAcao').innerHTML = `
      <button onclick="pararMusicaERecarregar()" class="btn-aurora verde">‚ôªÔ∏è Bora Pautar Nova Pauta</button>
    `;

  } catch (e) {
    console.error(e);
    document.getElementById('status').innerText = "Erro: " + e.message;
    document.getElementById('status').style.color = "red";
    document.getElementById('areaBotaoAcao').innerHTML = `
      <button onclick="pararMusicaERecarregar()" class="btn-aurora verde">‚ôªÔ∏è Tentar Novamente</button>
    `;
  }
}

// ---------------- BOT√ÉO √ÅUDIO ----------------
// Alterna o estado l√≥gico e envia comando ao App Inventor
function acionarAudio() {
  if (musicaTocando) {
    musicaTocando = false;
    enviarComandoApp("MUSICA_PAUSE");
  } else {
    musicaTocando = true;
    enviarComandoApp("MUSICA_PLAY");
  }
  atualizarIconeAudio();
}

// ---------------- BOT√ÉO ZAP ----------------
function acionarZap() {
  const box = document.getElementById('conteudoIA');
  if (!box) return;
  let texto = box.innerText;
  if (texto.length > 2000) texto = texto.substring(0, 2000) + "...";

  const title = "Agenda dos 300 - O Duelo de Colunistas";
  const footer = "\n\n üì∞ Agenda dos 300\n‚ö° Powered by Geraldo A. Seabra";
  const message = "‚ú® " + title + "\n\n" + texto + footer;

  if (window.AppInventor && window.AppInventor.setWebViewString) {
    // App Inventor recebe "SHARE:texto" e abre o compartilhamento nativo
    window.AppInventor.setWebViewString("SHARE:" + message);
  } else {
    window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(message), '_blank');
  }
}

// ---------------- RECARREGAR ----------------
function pararMusicaERecarregar() {
  musicaTocando = false;
  enviarComandoApp("MUSICA_PAUSE");
  location.reload();
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(() => console.log('SW OK'))
      .catch(err => console.log('SW Fail', err));
  });
}
</script>
</body>
</html>
